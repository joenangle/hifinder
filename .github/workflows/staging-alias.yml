name: Update Staging Alias

on:
  push:
    branches:
      - staging

jobs:
  update-staging-alias:
    runs-on: ubuntu-latest

    steps:
      - name: Wait for Vercel deployment
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.1
        id: wait_for_vercel
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 300
          check_interval: 10

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Update staging.hifinder.app alias
        run: |
          DEPLOYMENT_URL="${{ steps.wait_for_vercel.outputs.url }}"
          echo "Setting alias staging.hifinder.app ‚Üí $DEPLOYMENT_URL"

          # Set the alias with retry logic
          MAX_RETRIES=3
          RETRY=0

          while [ $RETRY -lt $MAX_RETRIES ]; do
            if vercel alias set "$DEPLOYMENT_URL" staging.hifinder.app --token=${{ secrets.VERCEL_TOKEN }} --scope team_Gic8SL9uR5MbiWqUFz2MehJQ; then
              echo "‚úÖ Successfully updated staging.hifinder.app"
              break
            else
              RETRY=$((RETRY + 1))
              if [ $RETRY -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è Alias update failed, retrying ($RETRY/$MAX_RETRIES)..."
                sleep 3
              else
                echo "‚ùå Failed to update alias after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

      - name: Verify alias
        run: |
          echo "Verifying alias is set correctly..."
          sleep 5

          # Check if the alias resolves
          ALIAS_CHECK=$(curl -s -o /dev/null -w "%{http_code}" https://staging.hifinder.app)

          if [ "$ALIAS_CHECK" -eq 200 ] || [ "$ALIAS_CHECK" -eq 308 ] || [ "$ALIAS_CHECK" -eq 301 ]; then
            echo "‚úÖ staging.hifinder.app is responding (HTTP $ALIAS_CHECK)"
          else
            echo "‚ö†Ô∏è staging.hifinder.app returned HTTP $ALIAS_CHECK (may need time to propagate)"
          fi

      - name: Post deployment info
        run: |
          echo "üöÄ Deployment complete!"
          echo "Staging URL: https://staging.hifinder.app"
          echo "Direct URL: ${{ steps.wait_for_vercel.outputs.url }}"
          echo "Commit: ${{ github.sha }}"
