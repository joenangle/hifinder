name: Update Staging Alias

on:
  deployment_status:

jobs:
  update-staging-alias:
    # Only run when:
    # 1. Deployment is successful
    # 2. It's from the staging branch
    # 3. It's a Vercel deployment (environment starts with "Preview")
    if: |
      github.event.deployment_status.state == 'success' &&
      github.event.deployment.ref == 'staging' &&
      startsWith(github.event.deployment.environment, 'Preview')

    runs-on: ubuntu-latest

    steps:
      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Update staging.hifinder.app alias
        run: |
          DEPLOYMENT_URL="${{ github.event.deployment_status.environment_url }}"
          echo "Deployment URL: $DEPLOYMENT_URL"
          echo "Branch: ${{ github.event.deployment.ref }}"
          echo "Environment: ${{ github.event.deployment.environment }}"

          vercel alias set "$DEPLOYMENT_URL" staging.hifinder.app \
            --token "${{ secrets.VERCEL_TOKEN }}" \
            --scope "${{ secrets.VERCEL_ORG_ID }}"

          echo "✅ Successfully updated staging.hifinder.app → $DEPLOYMENT_URL"
