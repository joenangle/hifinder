name: Update Staging Alias

on:
  push:
    branches: [staging]

jobs:
  update-staging-alias:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Wait for deployment and update alias
        run: |
          echo "üïê Waiting for Vercel deployment to complete..."

          MAX_ATTEMPTS=20
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."

            # Get latest deployment for staging branch
            DEPLOYMENT_INFO=$(vercel ls --yes --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }} | grep "Production" | head -1)

            if [ -z "$DEPLOYMENT_INFO" ]; then
              echo "No production deployment found yet, waiting..."
              sleep 30
              continue
            fi

            # Extract URL and status
            LATEST_URL=$(echo "$DEPLOYMENT_INFO" | grep -o 'https://[^ ]*' | head -1)
            STATUS=$(echo "$DEPLOYMENT_INFO" | grep -o '‚óè [A-Za-z]*' | sed 's/‚óè //')

            echo "Deployment URL: $LATEST_URL"
            echo "Status: $STATUS"

            if [ "$STATUS" = "Ready" ]; then
              echo "‚úÖ Deployment is ready!"
              echo "Updating staging alias to: $LATEST_URL"

              vercel alias set $LATEST_URL staging.hifinder.app --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }}

              if [ $? -eq 0 ]; then
                echo "‚úÖ Successfully updated staging.hifinder.app!"
                exit 0
              else
                echo "‚ùå Failed to update alias"
                exit 1
              fi
            else
              echo "Deployment status: $STATUS - waiting 30s..."
              sleep 30
            fi
          done

          echo "‚ùå Timeout waiting for deployment to be ready"
          exit 1