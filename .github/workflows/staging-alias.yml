name: Update Staging Alias

on:
  push:
    branches:
      - staging

jobs:
  update-staging-alias:
    runs-on: ubuntu-latest

    steps:
      - name: Wait for Vercel deployment
        id: wait
        run: |
          echo "⏳ Waiting for Vercel to deploy commit ${{ github.sha }}..."

          COMMIT_SHA="${{ github.sha }}"
          MAX_ATTEMPTS=60
          ATTEMPT=0
          DEPLOYMENT_URL=""

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Looking for deployment of commit ${COMMIT_SHA:0:7}"

            # Get latest deployments
            RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              "https://api.vercel.com/v6/deployments?projectId=prj_D9SCi3ptkkrWB44UfdjTFKhP5BN2&limit=10&teamId=team_Gic8SL9uR5MbiWqUFz2MehJQ")

            # Find deployment matching THIS commit SHA that is READY
            DEPLOYMENT_INFO=$(echo "$RESPONSE" | jq -r --arg sha "$COMMIT_SHA" '.deployments[] | select(.meta.githubCommitSha == $sha and .readyState == "READY") | {url: .url, commit: .meta.githubCommitSha[0:7]} | @base64' | head -1)

            if [ -n "$DEPLOYMENT_INFO" ]; then
              DEPLOYMENT_URL=$(echo "$DEPLOYMENT_INFO" | base64 --decode | jq -r '.url')
              COMMIT_SHORT=$(echo "$DEPLOYMENT_INFO" | base64 --decode | jq -r '.commit')
              echo "✅ Found READY deployment for commit $COMMIT_SHORT: $DEPLOYMENT_URL"
              echo "url=https://$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
              break
            fi

            sleep 5
          done

          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "❌ No deployment found for commit ${COMMIT_SHA:0:7} after 5 minutes"
            exit 1
          fi

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Set staging alias
        run: |
          DEPLOYMENT_URL="${{ steps.wait.outputs.url }}"
          echo "🔗 Setting alias: staging.hifinder.app → $DEPLOYMENT_URL"

          vercel alias set "$DEPLOYMENT_URL" staging.hifinder.app \
            --token="${{ secrets.VERCEL_TOKEN }}" \
            --scope=team_Gic8SL9uR5MbiWqUFz2MehJQ

          echo "✅ Alias set successfully!"

      - name: Summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🚀 Staging Updated"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "URL: https://staging.hifinder.app"
          echo "Direct: ${{ steps.wait.outputs.url }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
