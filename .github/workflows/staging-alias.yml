name: Update Staging Alias

on:
  push:
    branches:
      - staging

jobs:
  update-staging-alias:
    runs-on: ubuntu-latest

    steps:
      - name: Wait for Vercel deployment to complete
        id: get_deployment
        run: |
          echo "â³ Waiting for Vercel to deploy staging branch..."

          MAX_ATTEMPTS=60
          ATTEMPT=0
          DEPLOYMENT_URL=""

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS"

            # Call Vercel API to get latest deployment for staging branch
            RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              "https://api.vercel.com/v13/deployments?projectId=prj_D9SCi3ptkkrWB44UfdjTFKhP5BN2&gitBranch=staging&limit=1&teamId=team_Gic8SL9uR5MbiWqUFz2MehJQ")

            # Extract deployment URL and state
            DEPLOYMENT_URL=$(echo "$RESPONSE" | jq -r '.deployments[0].url // empty')
            STATE=$(echo "$RESPONSE" | jq -r '.deployments[0].state // empty')

            if [ -n "$DEPLOYMENT_URL" ]; then
              echo "ğŸ“¦ Found deployment: https://$DEPLOYMENT_URL"
              echo "ğŸ“Š State: $STATE"

              if [ "$STATE" = "READY" ]; then
                echo "âœ… Deployment is ready!"
                echo "url=https://$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
                break
              else
                echo "â³ Deployment not ready yet (state: $STATE), waiting..."
              fi
            else
              echo "âŒ No deployment found yet, waiting..."
            fi

            ATTEMPT=$((ATTEMPT + 1))
            sleep 5
          done

          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "âŒ Failed to find deployment after $MAX_ATTEMPTS attempts"
            exit 1
          fi

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Set staging alias
        run: |
          DEPLOYMENT_URL="${{ steps.get_deployment.outputs.url }}"
          echo "ğŸ”— Setting alias: staging.hifinder.app â†’ $DEPLOYMENT_URL"

          vercel alias set "$DEPLOYMENT_URL" staging.hifinder.app \
            --token="${{ secrets.VERCEL_TOKEN }}" \
            --scope=team_Gic8SL9uR5MbiWqUFz2MehJQ

          echo "âœ… Alias updated successfully!"

      - name: Verify alias is live
        run: |
          echo "ğŸ” Verifying staging.hifinder.app..."
          sleep 3

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://staging.hifinder.app)
          echo "HTTP status: $HTTP_CODE"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
            echo "âœ… staging.hifinder.app is live!"
          else
            echo "âš ï¸  Received HTTP $HTTP_CODE (may need time to propagate)"
          fi

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Deployment Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Staging URL: https://staging.hifinder.app"
          echo "Direct URL:  ${{ steps.get_deployment.outputs.url }}"
          echo "Commit:      ${{ github.sha }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
