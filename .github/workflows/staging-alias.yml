name: Update Staging Alias

on:
  push:
    branches: [staging]

jobs:
  update-staging-alias:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Update staging alias
        run: |
          echo "Waiting for deployment to complete..."
          sleep 90

          echo "Getting latest deployment..."
          LATEST_URL=$(vercel ls --yes --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }} | grep "https://" | head -1 | awk '{print $1}')

          echo "Latest deployment URL: $LATEST_URL"

          if [ -z "$LATEST_URL" ]; then
            echo "ERROR: No deployment URL found"
            exit 1
          fi

          echo "Updating staging alias..."
          vercel alias set $LATEST_URL staging.hifinder.app --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }}

          echo "âœ… Successfully updated staging.hifinder.app!"