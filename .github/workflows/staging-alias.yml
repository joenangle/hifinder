name: Update Staging Alias

on:
  push:
    branches: [staging]

jobs:
  update-staging-alias:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Wait for deployment and update alias
        run: |
          echo "üïê Waiting for Vercel deployment to complete..."
          echo "Commit SHA: ${{ github.sha }}"

          MAX_ATTEMPTS=20
          ATTEMPT=0
          GIT_STAGING_ALIAS="https://hifinder-git-staging-joenangles-projects.vercel.app"

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."

            # Inspect the git-staging alias to find the actual deployment URL
            INSPECT_OUTPUT=$(vercel inspect "$GIT_STAGING_ALIAS" --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }} 2>&1)

            # Extract the actual deployment URL
            DEPLOYMENT_URL=$(echo "$INSPECT_OUTPUT" | grep -o 'https://hifinder-[a-z0-9]*-[^[:space:]]*\.vercel\.app' | head -1)

            if [ -z "$DEPLOYMENT_URL" ]; then
              echo "Could not find deployment URL yet, waiting 30s..."
              sleep 30
              continue
            fi

            echo "Found deployment: $DEPLOYMENT_URL"

            # Check if deployment is ready
            if echo "$INSPECT_OUTPUT" | grep -q "status.*‚óè Ready"; then
              echo "‚úÖ Deployment is Ready!"
              echo "Updating staging.hifinder.app to point to: $DEPLOYMENT_URL"

              vercel alias set "$DEPLOYMENT_URL" staging.hifinder.app --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }}

              if [ $? -eq 0 ]; then
                echo "‚úÖ Successfully updated staging.hifinder.app!"
                exit 0
              else
                echo "‚ùå Failed to update alias"
                exit 1
              fi
            else
              echo "‚è≥ Deployment not ready yet, waiting 30s..."
              sleep 30
            fi
          done

          echo "‚ùå Timeout waiting for deployment to be ready"
          exit 1